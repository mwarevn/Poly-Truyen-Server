<script src="/js/support.js"></script>
<style>
  html {
    scroll-behavior: smooth;
  }
</style>
<a href="/home" class="btn bg-white hover:bg-white border-0 hover:border-2 btn-sm m-5 text-secondary">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
  </svg>
  Back
</a>

<div class="hero my-5">
  <div class="hero-content flex-col lg:flex-row p-0 m-0">
    <img src="https://daisyui.com/images/stock/photo-1635805737707-575885ab0820.jpg" class="poster w-64 rounded-lg shadow-2xl me-4" />
    <div>
      <span class="names" data-id="<%= id %>"></span>
      <b class="text-2xl font-bold" id="display-name">Hello</b>
      <div class="py-1"><b>Author: </b><span class="author"></span></div>
      <div class="py-1"><b>publicAt: </b><span class="createdAt"></span></div>
      <p><b>Description: </b></p>
      <span class=" h-40 block desc" style="overflow-y: scroll;width: 701px; "></span>
      <a class="btn btn-outline btn-secondary" href="#position-comment">Bình luận</a>
    </div>
  </div>
</div>
<div class="divider">Kéo xuống để đọc</div>
<!-- <div class="grid grid-cols-4 gap-4">
</div> -->
<section class=" contents-container">
</section>

<!-- comments -->
<div class="border border-4 border-dashed mx-auto p-2 min-h-96" style="width: 900px;" id="position-comment">
  <a class="link link-accent ms-2 mt-2 block flex" href="#">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 me-1">
      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
    </svg>
    về đầu trang
  </a>
  <div class="divider divider-start">Bình luận</div>
  <div class="flsex items-center">
    <textarea class="textarea textarea-bordered w-full h-48" placeholder="Nhập bình luận"></textarea>
    <button class="btn btn-save-comment btn-sm btn-outline btn-neutral mt-4">
      Gửi bình luận
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
      </svg>
    </button>
  </div>

  <div class="divider"></div>

  <aside class="comments-container px-4 min-h-96 block overflow-y-scroll"></aside>

</div>
<script>
  var id = document.querySelector('span.names')
    .getAttribute("data-id");


  const name = document.getElementById('display-name');
  const author = document.querySelector('.author');
  const createdAt = document.querySelector('.createdAt');
  const desc = document.querySelector('.desc');
  const poster = document.querySelector('.poster');
  const contentsContainer = document.querySelector('.contents-container')
  const commentsContainer = document.querySelector('.comments-container')
  var listComments = []

  const fillComment = () => {

    var newList = [...listComments];

    if (newList.length <= 0) {
      commentsContainer.innerText = "Hãy là người đầu tiên bình luận!";
      return
    }

    commentsContainer.innerHTML = newList.reverse()
      .map((e, i) => {
        if (e.idUser) {
          return `
            <div class="chat chat-start">
              <div class="chat-image avatar">
                <div class="w-10 rounded-full">
                  <img src=${e.idUser.role == "admin" ? 'https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg' : 'https://assets-global.website-files.com/6411daab15c8848a5e4e0153/64a3587a690c6ddc503ee672_Avatar_No%20photo.png'} />
                </div>
              </div>
              <div class="chat-header">
                ${e.idUser.fullName}
                ${e.idUser.role && e.idUser.role == "admin" ? '<img src="/icons/verify.png" class="inline"/>' : ""}
                <time class="text-xs opacity-50">${convertDateTime(e.createdAt)}</time>
              </div>
              <div class="chat-bubble">${e.content}</div>
            </div>
            `;
        } else {
          return `
            <div class="chat chat-start">
              <div class="chat-image avatar">
                <div class="w-10 rounded-full">
                  <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZUhZZylV5X9rkMQEhhA54r9rLFuxxwpUgAt0xg30R5jLjlVPUnM7FTfcJMsWCCs2LzcE&usqp=CAU" />
                </div>
              </div>
              <div class="chat-header text-error">
                Tài khoản đã xóa
                <time class="text-xs opacity-50">${convertDateTime(e.createdAt)}</time>
              </div>
              <div class="chat-bubble">${e.content}</div>
            </div>
            `;
        }
      })
      .join('')
  }

  // get comments of comic
  fetch('/comment/comic/' + id)
    .then(res => {
      return res.json()
    })
    .then(res => {
      listComments = res
      fillComment()
    })

  // get contents of comic
  fetch(`/comic/` + id)
    .then(res => res.json())
    .then(res => {
      name.innerText = res.name;
      author.innerText = res.author;
      createdAt.innerText = convertDateTime(res.createdAt);
      desc.innerText = res.desc;
      poster.src = "/images/" + res.poster;

      contentsContainer.innerHTML = res.contents.reverse()
        .map((e, i) => {
          return `<img class="block mx-auto" src="/images/${e}" />`
        })
        .join("")
    });

  // handle send new comment from admin panel
  document.addEventListener('DOMContentLoaded', () => {
    var idUser = document.cookie.split("admin=")[1].split(";")[0];
    var btnSaveComment = document.querySelector('.btn-save-comment');
    var inputContent = document.querySelector('textarea');


    btnSaveComment.onclick = e => {


      if (inputContent.value == "") {
        Toastify({
            text: "Vui lòng không bỏ trống bình luận",
            duration: 3000,
            close: true,
            gravity: "bottom",
            position: "center",
            stopOnFocus: true,
            style: {
              background: "red"
            },
          })
          .showToast();
        return;
      }

      var commentPayload = {
        idComic: id,
        idUser: idUser,
        content: inputContent.value
      }

      fetch(`/comment/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(commentPayload)
        })
        .then(res => res.json())
        .then(res => {

          if (res._id) {
            inputContent.value = ""
            listComments.push(res);
            fillComment()
          }
        })

    }


  })
</script>